services:
  dub:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ai-dub
    # ✅ GPU 전달 (Docker Desktop/WSL2 모두 호환)
    gpus: all
    environment:
      USE_GPU: "1"
      TTS_DEVICE: "cuda"
      COQUI_TOS_AGREED: "1"
      HF_HOME: /app/cache/hf
      TRANSFORMERS_CACHE: /app/cache/hf
      HUGGINGFACE_HUB_CACHE: /app/cache/hf
      TTS_HOME: /app/cache/tts
      WHISPER_BACKEND: whisperx   # whisperx | faster
      WHISPER_MODEL: large-v3
      WHISPER_BATCH_SIZE: "8"
      WHISPERX_ALIGN: "1"
      WHISPER_LANG: ko
      TTS_MODEL: "tts_models/multilingual/multi-dataset/xtts_v2"
      # (선택) 일부 런타임이 요구할 수 있음
      NVIDIA_VISIBLE_DEVICES: "all"
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility"
    volumes:
      - ./data:/app/data
      - ./data/hf_cache:/app/cache/hf
      - ./data/tts_cache:/app/cache/tts
    ports:
      - "8000:8000"
    shm_size: "2gb"   # (선택) 데이터로더/음성 처리 시 유용
